

Evolutionary, demographic, and epidemiological processes leave a footprint in the branch length distribution and topology of reconstructed phylogenetic trees. This insight has inspired a huge effort to extract information about these processes by fitting stochastic models. For example, in molecular epidemiology, researchers have leveraged the fact that for many viral pathogens, such as HIV and SARS-CoV-2, accumulate genetic diversity on the timescale of transmission (Drummond et al. 2003; Duffy et al. 2008) . This genetic diversity can be used to reconstruct the evolutionary relationships between viral variants sampled from different hosts, which in turn can help elucidate the epidemiological dynamics of a pathogen over time (Grenfell et al. 2004; Volz 2012) . Similarly, phylogenetic trees can provide unique insights into the temporal variation in speciation and extinction rates (Morlon 2014) .Phylogenetic branching models can be broadly grouped into two classes. The first, based on Kingman's coalescent process (Kingman 1982) , has been widely used to examine changes in the historical population size of pathogens (Pybus et al. 2000; Strimmer and Pybus 2001; Drummond et al. 2005; Volz et al. 2009 ). These coalescent methods have also been applied to reconstruct macroevolutionary dynamics (Morlon et al. 2010) . Coalescent models are well suited for estimating deterministic population dynamics; however, fitting highly stochastic processes, such as the dynamics of an emerging pathogen, is computationally intensive and in some cases the assumptions of the coalescent may not be appropriate Boskova et al. 2014 ; Volz and Frost 2014) . The second class of models, which are collectively referred to as birth-death-sampling (BDS) models (Kendall 1948; Maddison et al. 2007; Stadler 2009; Stadler 2010) , is well suited for stochastic scenarios, and are thus becoming an increasingly favorable and popular alternative to coalescent models in epidemiology and have long been the foundation of most macroevolutionary studies-both for inferring speciation and extinction dynamics (Raup 1985; Nee et al. 1994 ) and for estimating divergence times (Gernhard 2008; Heath et al. 2014) . As the name implies, the BDS process includes three types of events: birth (pathogen transmission between hosts, or speciation in a macroevolutionary context), death (host death or recovery, or extinction in macroevolution), and sampling (including fossil collection in macroevolution).In the context of epidemiology, BDS models have the additional property that the model parameters, which can be estimated from viral sequence data, explicitly correspond to parameters in classic structured epidemiological models that are often fit to case surveillance data. If we reparameterize these models, we can describe the dynamics of the basic and effective reproductive ratios (R 0 and R e , respectively) over time ) (see Box 1). A common research aim is to describe how the frequency of birth, death, and sampling events, and other derived variables such as R e , change throughout the course of an epidemic. There has been less work in macroevolution linking the parameters of a BDS model to those of an underlying more mechanistic 172 (gray) lines and classes represent rates and variables followed (in)directly by the BDS model. The SIR model can be used to constrain the rates of the BDS model (a). Simulated forward in time, the result of the BDS stochastic processes is a full tree (b) giving the complete genealogy of the viral population. Pruning away extinct and unsampled lineages produces the sampled tree (c). Arising from a BDS process, this sampled tree can be summarized in two ways. First by the set of edges (labeled 1-11) or as a set of critical times (horizontal lines) including: 1) the time of birth events (solid, x i ) 2) terminal sampling times (dashed, y j ), and 3) ancestral sampling times (dotted, z k ). Given the inferred rates from a reconstructed sampled tree, these rates can be used to estimate characteristic parameters of the SIR model, for example, the basic or effective reproductive number.

BOX 1: THE CONNECTION BETWEEN BDS AND SIR MODELS

The single-type BDS model is intimately related to the SIR compartmental model used in classic theoretical epidemiology. This connection illustrates the explicit and implicit assumptions of the general BDS model and its sub models.Here, we define the SIR epidemiological model, discuss how it can inform and be informed by these diversification models, and examine the shared assumptions of the two frameworks.

The SIR Model:

The SIR model partitions the host population via infection status into susceptible (S), infected (I), and recovered (R) hosts. Infection of susceptible hosts occurs at a per-capita rate I. Infected hosts may recover (at rate ), die of virulent cases (at rate ), or be sampled (at rate ). The cumulative number of sampled hosts is represented in the SIR model ( Figure B .1 top) by I * . Upon sampling, infected hosts may be treated and hence effectively recover with probability r. Hosts that have recovered from infection exhibit temporary immunity to future infection which wanes at rate . The special case of the SIR model with no immunity (the SIS model) is obtained in the limit as →∞. In addition to these epidemiological processes, the SIR model includes demographic processes, such as host birth (rate B) and death from natural causes (rate ). While not shown explicitly in the figure, these epidemiological and demographic rates may change over time as a result of host behavioral change, pharmaceutical and nonpharmaceutical interventions, or host/pathogen evolution.

The BDS Model:

The BDS model follows the number of sampled and unsampled viral lineages over time, analogous to the I and I * classes of the SIR model. A key element of general BDS model is that birth and death rates may vary over time. This time dependence may VOL. 71 be either continuous (Morlon et al. 2011; Rabosky and Lovette 2008b) or discrete (Stadler 2011; Gavryushkina et al. 2014; Kühnert et al. 2014) Although arbitrarily timedependent, the birth, death, and sampling rates in the general BDS model are assumed to be diversityindependent, analogous to the assumption of density-dependent transmission (pseudo mass action) in the SIR model (Keeling and Rohani 2008) . Incorporating such diversity dependence into macroevolutionary models has been shown to increase the accuracy of extinction rate estimates and are necessary to accurately capture the saturation of diversity . While some forms of diversity-dependence in diversification rates may be incorporated implicitly capturing deterministic diversity dependence as time dependence (Rabosky and Lovette 2008a) , stochastic diversity-dependence (Etienne and Rosindell 2012) goes beyond the scope of the BDS models considered here. The single-type BDS model assumes all viral lineages are exchangeable-this has several implications. First, all viral lineages are epidemiologically identical hence all mutations between them are neutral. Incorporating nonneutral genetic variation requires a multitype approach as in Equation (16). Second, transmission is independent of lineage age. In the macroevolutionary case, such age-dependence has been suggested to reflect niche differentiation in novel species (Hagen et al. 2015) and in the epidemiological case may reflect adaptation towards increased transmissibility following a host species-jumping event. Third, lineage exchangeability is reflected in the absence of an exposed (E) class in the SIR model in which hosts can, for example, transmit infections but not be sampled or vice versa. Finally, the single-type BDS model assumes all lineages are sampled at random and does not include submodels with nonrandom representation of lineages .

Model Connections

Given their shared model assumptions, the singletype BDS model can be constrained explicitly to reflect an underlying SIR epidemic by setting the viral birth rate equal to the per-capita transmission rate of the infectious class () = S() and the viral death rate to the infectious recovery or removal rate () = ++, whereas the sampling rate () is identical across models ( Figure B1a ). While constraining the birth, death, and sampling rates in this manner can be used to parameterize compartmental models (Kühnert et al. 2014 ) doing so is an approximation assuming independence between the exact timing of transmission, recovery or removal from the population, and sampling events in the SIR model and birth, death, and sampling events in the diversification model. The resulting tree likelihood in terms of the compartmental model is given by:While they are not submodels of the general BDS process given by equation 13, likelihood models have been developed that capture the full nonindependence of viral diversification and epidemiological dynamics for the SIR model specifically (Leventhal et al. 2012 ) and in compartmental models in general . The connection between the BDS process and SIR epidemiological models can also be used after the diversification rates are inferred to estimate the basic and effective reproductive rates . Specifically, the effective reproductive rate at time before the present day is given by R e () = () ()+r() () . Although the SIR model is a useful epidemiological model for is simplicity, realistically modeling epidemic dynamics requires far more complex compartmental models. As reflected by their shared structure, the application of the single-type BDS model is restricted, however, to the assumptions of the SIR model alone and further methodological advances in multitype modeling are necessary for direct inference for the larger class of epidemiological models. model (but see Ezard et al. 2016 ) but this seems like a promising avenue for future development. As we detail below and in the Supplementary material available at Dryad at https://doi.org/10.5281/zenodo.5028470, there has been an astounding rise in the variety and complexity of BDS model variants. A key assumption in the specification of BDS submodels is whether all lineages alive at some time point are exchangeable (Stadler 2013 ) (such models are hereafter "single-type" models), meaning they diversify according to the same process, or if rather the diversification process is variable ("multitype" models; e.g., Maddison et al. 2007; FitzJohn 2012; Rasmussen and Stadler 2019; Barido-Sottani et al. 2018) , with lineages belonging to one of multiple possible states each characterized by a unique process. Each of these diversification processes can then be characterized by different dynamical assumptions. In the epidemiological case, these assumptions specify, for example, the nature of viral transmission and the sampling procedure Kühnert et al. 2014; Gavryushkina et al. 2014 ). While typically not explicitly tied to mechanistic evolutionary processes, there are a similar abundance of dynamical assumptions employed in the macroevolutionary context specifying the nature of biodiversity change through time (Nee 2006; Gernhard 2008; Morlon et al. 2011; Stadler 2011; Morlon 2014; Heath et al. 2014; Louca 2020) .This flourishing of methods and models has facilitated critical insights into epidemics (du Plessis and Stadler 2015; Joy et al. 2016 ) and the origins of contemporary biodiversity (Morlon 2014; Schluter and Pennell 2017) . However, this diversity of models has made it difficult to trace the connections between variants and to understand the precise epidemiological, evolutionary, and sampling processes that differ between them. Furthermore, despite their apparent similarities, these models have been derived on a case-by-case basis using different notation and techniques; this creates a substantial barrier for researchers working to develop novel models for new situations. And critically, it is imperative that we understand the general properties of BDS phylogenetic models and the limits of inferences from them (Louca and Pennell 2020a; Louca et al. 2021) , and this is difficult to do without considering the full breadth of possible scenarios. Here, we address all of these challenges by unifying the whole class of phylogenetic BDS models. We do so by first deriving a likelihood for general single-and multitype BDS models; in the general case, we do not assume anything about the functional forms (i.e., temporal dynamics) of the various parameters including the sampling rate through time, the possibility of sampling ancestors (or not), or how the process was conditioned. While such general models may be useful for studying the mathematical properties of BDS models as a whole (Lambert and Stadler 2013; Louca and Pennell 2020a; Louca et al. 2021) , statistical inference from these models requires researchers to make further constraints on the process. We prove that existing BDS model variants are indeed submodels of the more general case-and thereby clarify the specific assumptions made by different models-and provide a standardized notation and technique for deriving these and other submodels that have not previously been considered in the literature.The Single-type Birth-Death-Sampling Model Model specification.-The BDS stochastic process begins with a single lineage at time T before the present day. We note that this may be considerably older than the age of the most recent common ancestor of an observed sample which is given by t MRCA . While we focus primarily on applications to epidemiology, our approach is agnostic to whether the rates are interpreted as describing pathogen transmission or macroevolutionary diversification.In the model, transmission/speciation results in the birth of a lineage and occurs at rate (), where (0 ≤ ≤ T) is measured in units of time before the present day ( = 0), such that can be time-dependent. We make the common assumption that lineages in the viral phylogeny coalesce exactly at transmission events, thus ignoring the within-host coalescent processes in the donor (Romero-Severson et al. 2016) . Throughout, we will use as a a general time variable and t × to denote the time at which a specific event × occurs as measured in units of time before the present day (see Supplementary Table S1 ). Lineage extinction, resulting from host recovery or death in the epidemiological case or the death of all individuals in a population in the macroevolutionary case, occurs at time-dependent rate (). We allow for two distinct types of sampling: lineages are either sampled according to a Poisson process through time () or binomially at very short intervals, which we term "concerted sampling attempts" (CSAs), where lineages at some specified time t l are sampled with probability l ( denotes a vector of concerted sampling events at different time points). In macroevolutionary studies based only on extant lineages, there is no Poissonian sampling, but a CSA at the present ( 0 > 0). In epidemiology, CSAs correspond to large-scale testing efforts (relative to the background rate of testing) in a short amount of time (relative to the rates of viral sequence divergence); for full explanation, see Appendix. We call these attempts rather than events because if is small or the infection is rare in the population, few or no samples may be obtained. CSAs can also be incorporated into the model by including infinitesimally short spikes in the sampling rate (more precisely, appropriately scaled Dirac distributions). Hence, for simplicity, in the main text we focus on the seemingly simpler case of pure Poissonian sampling through time except at the presentday, where we allow for a CSA to facilitate comparisons with macroevolutionary models; the resulting formulas can then be used to derive a likelihood formula for the case where past CSAs are included (see Appendix).In the epidemiological case, sampling may be concurrent (or not) with host treatment or behavioral changes resulting in the effective extinction of the viral lineage. Hence, we assume that sampling results in the immediate extinction of the lineage with probability r(). As with the CSAs, this arbitrary time dependence allows for the incorporation of Dirac spikes in any of these variables, for example, with mass extinctions () and lagerstätten in the fossil record ( (1−r)) (Magee and Höhna 2021) . Similarly, in the case of past CSAs, we must include the probability, r l , that sampled hosts are removed from the infectious pool during the CSA at time t l . Poissonian sampling without the removal of lineages (r() < 1) can be employed in the macroevolutionary case to explicitly model the collection of samples from the fossil record (such as the fossilized-birth-death process; Heath et al. 2014) .For our derivation, we make no assumption about the temporal dynamics of , , , or r; each may be constant, or vary according to any arbitrary function of time given that it is biologically valid (nonnegative and between 0 and 1 in the case of r). Specifically, the time-varying functions may be any piecewise-continuous functions of time with at most finite number of discontinuities (see Rate Assumption section in the Appendix). Note that these functions need not be differentiable. We make VOL. 71 the standard assumption that at any given time any given lineage experiences a birth, death or sampling event independently of (and with the same probabilities as) all other lineages. We revisit this assumption in Box 1 where we discuss how the implicit assumptions of the single-type BDS process are well summarized by the diversification model's relationship to the SIR epidemiological model. Our resulting general timevariable BDS process can be fully defined by the parameter set BDS ={(),(), (),r(), }.In order to make inference about the model parameters, we need to calculate the likelihood, L, that an observed phylogeny, T , is the result of a given BDS process. With respect to the BDS process there are two ways to represent the information contained in the phylogeny T , both of which have been used in the literature, which we call the "edge" and "critical time" representations, respectively. We begin by deriving the likelihood in terms of the edge representation and later demonstrate how to reformulate the likelihood in terms of critical times. In the edge representation, the phylogeny is summarized as a set of edges in the mathematical graph that makes up the phylogeny, numbered 1-11 in Figure B .1c, and the types of events that occurred at each node. We define g e () as the probability that the edge e which begins at time s e and ends at time t e gives rise to the subsequently observed phylogeny between time , (s e << t e ) and the present day. The likelihood of the model for the observed tree is then, is by definition g stem (T): the probability density that the stem lineage (stem = 1 in Figure B .1c) gives rise to the observed phylogeny from the origin, T, to the present day. We find that it is more intuitive to derive the likelihood in terms of the edge representation, as we show below; from this it is straightforward to derive the critical times formulation which results in mathematical simplification. Below, we present our five-step technique for the derivation of the tree likelihood.Step 1. Deriving the Initial Value Problem (IVP) for g e ().-We derive the IVP for the likelihood density g e () using an approach first developed by (Maddison et al., 2007) . We begin by deriving the recursion equation for g e by considering all the possible events that could occur along edge e between time and + assuming that that is small enough such that at most one event is likely to occur.(1)Here, E() is the probability that a lineage alive at time leaves no sampled descendants at the present day. We will examine this probability in more detail below. Assuming is small, we can approximate the above recursion equation as the following difference equation.(2)By the definition of the derivative, we have:Equation (3) is known as the Kolmogorov backward equation of the BDS process (Feller 1949; Louca and Pennell 2020b) . Beginning at time s e , the initial condition of g e depends on which event occurred at the beginning of edge e.birth event giving rise to edges e1 and e2 (1−r(s e )) (s e )g e1 (s e ) ancestral sampling event (s e )r(s e )+ (s e )(1−r(s e ))E(s e ) terminal sampling event 0 s e = 0, extant sample (4) Together Equations (3) and (4) define the initial value problem for g e () as a function of the probability E().Because the likelihood density g e is the solution to a linear differential equation with initial condition at time s e , we can express its solution as follows:where the auxiliary function, , is given by:(6) This function, (s,t), maps the value of g e at time s to its value at t, and hence is known as the probability "flow" of the Kolmogorov backward equation (Louca and Pennell 2020b) .Step 2. Deriving the IVP for E().-We derive the IVP for E() in a similar manner as above, beginning with a difference equation.By the definition of a derivative, we have:where 0 is the probability a lineage is sampled at the present day. The initial condition at time 0 is therefore the probability that a lineage alive at the present day is not sampled. Given an analytical or numerical general solution to E(), we can find the likelihood by evaluating g stem (T), as follows.Step 3. Deriving the expression for g stem (T).-Given the linear nature of the differential equation for g e () and hence the representation in Equation (5)), the likelihood g stem () is given by the product over all the initial conditions times the product over the probability flow for each edge.where x i , y j , and z k are the times at which individual birth, terminal sampling and ancestral sampling events occur as we elaborated below.Step 4. Representing g stem (T) in terms of critical times.-Equation (9) can be further simplified by removing the need to enumerate over all the edges of the phylogeny (the last term of Equation (9)) and writing L in terms of the tree's critical times (horizontal lines in Fig. B .1). The critical times of the tree are made up of three vectors, x, y, and z, as well as the time of origin T. The vector x gives the time of each birth event in the phylogeny and has length I = N 0 +n−1, where N 0 is the number of lineages sampled at the present day and n is the number of terminal samples. Unless noted otherwise the elements of vector x are listed in decreasing order, such that x 1 > x 2 > ...x I and hence x 1 is the time of the most recent common ancestor t MRCA . The vector y gives the timing of each terminal sample and hence has length n whereas vector z gives the timing of each ancestral sample and has length m. With respect to the BDS likelihood then the sampled tree is summarized by T ={ x, y, z,T}. We note that the critical times only contain the same information as the edges as a result of the assumptions of the BDS process but are not generally equivalent representations of T . As a result of the linear nature of g e () it is straightforward to rewrite the likelihood in Equation (9) in terms of the critical-time representation of the sampled tree. Defining (10) the probability flow can be rewritten as the following ratio:This relationship allows us to rewrite the likelihood by expressing the product over the edges as two separate products, one over the start of each edge and the other over the end of each edge which in turn allows us to rearrange and cancel terms to obtain an alternative likelihood expression. Edges begin (value of t e ) at either: 1) the tree origin, 2) a birth event resulting to two lineages, or 3) an ancestral sampling event. Edges end (values of s e ) at either: 1) a birth event, 2) an ancestral sampling event, 3) a terminal sampling event, or 4) the present day. Hence we have:Note (0) = 1. While Equations (9) and (12) are numerically identical, the critical time expression is more convenient for application as it requires numerically evaluating only a single function () as given by Equation (10).Step 5. Conditioning the likelihood.-While Equation (12) is equal to the basic model likelihood for the phylogeny T , it is often appropriate to condition the tree likelihood on the tree exhibiting some property, for example the condition there being at least sampled lineage. Imposing a condition on the likelihood is done by multiplying by a factor S. Various conditioning schemes are considered in section A4 and listed in Table S3 with the value of S ranging in complexity from a constant to a general function of the model parameters. The resulting VOL. 71 likelihood expression for the general BDS model is:

Many Existing Models are Special Cases of this General BDS Model

A large variety of previously published BDS models in epidemiology and macroevolution are special cases of the general model presented here (for a summary of the models we investigated, see Supplementary  Table S2 . Indeed, we can obtain the likelihood of these models by adding mathematical constraints (i.e., simplifying assumptions) to the terms in Equation (13). Our work thus not only provides a consistent notation for unifying a multitude of seemingly disparate models, it also provides a concrete and numerically straightforward recipe for computing their likelihood functions. We recognize that there are many valid approaches for deriving tree likelihoods for BDS models with share many similarities with our own (e.g., Nee et al. 1994; Maddison et al. 2007; Gernhard 2008; Morlon et al. 2011; Lambert and Stadler 2013; Lambert 2018; Laudanno et al. 2020; Louca and Pennell 2020b) and do not claim ours is superior to these; however, we have found our technique to be intuitive and flexible. We have implemented the single-type BDS likelihood in the R package castor (Louca and Doebeli 2018), including routines for maximum-likelihood fitting of BDS models with arbitrary functional forms of the parameters given a phylogeny and routines for simulating phylogenies under the general BDS models (functions fit_hbds_model_on_grid, fit_hbds_model_parametric and generate_tree_hbds). Figure 1 summarizes the simplifying assumptions that underlie common previously published BDS models; these assumptions generally fall into four categories: 1) assumptions about the functional form of birth, death, and sampling rates over time, 2) assumptions pertaining to the sampling of lineages, 3) the presence of mass-extinction events, and 4) the nature of the tree-conditioning as given by S. Here, we provide a brief overview of the type of previously invoked constraints which are consistent (or not) with our unified framework; for full details on each specific case, we refer readers to the Supplementary material. While we illustrate these constraints within the single-type context, analogous assumptions can be made within the multitype context examined in the following section.In regards to rate assumptions, many early BDS models (Stadler 2009; Stadler 2010; Stadler et al. 2012) assumed that the birth, death, and sampling rates remained constant over time. This is mathematically and computationally convenient since an analytical solution can easily be obtained for E(). In the epidemiological case, holding constant, however, implies that the number of susceptible hosts is effectively constant throughout the epidemic and/or that the population does not change its behavior over time; this is an unrealistic assumption given seasonal changes or changes in response to the disease itself. As such, this assumption is only really valid for small time periods or the early stages of an epidemic. This is useful for estimating the basic reproductive number, R 0 , of the SIR model (Box 1) but not for the effective reproductive number R e at later time points .A similarly tractable, but more epidemiologically relevant, model is known as the "birth-death-skyline" variant Gavryushkina et al., 2014) , in which rates are piecewise-constant functions through time (like the constant rate model, there is also an analytical way to calculate the likelihood of this model; see Appendix). The BDS skyline model has been implemented under a variety of additional assumptions in the Bayesian phylogenetics software BEAST2 (Bouckaert et al. 2019) . The BDS skyline model has also been extended by (Kühnert et al., 2014) to infer the the parameters of an underlying stochastic SIR model. In this case the diversification model parameters BDS are random variables that emerge from stochastic realizations of the epidemiological model given by SIR , see Equation (B1). Finally, the birth-death skyline model with piecewise constant rates can also be applied in the macroevolutionary case when no sampling occurs through time, () = 0 (Stadler 2011) .In addition to imposing constraints on the temporal variation in the rates, previously derived submodels have considered a variety of different assumptions about the nature of the sampling process. Most notably, in macroevolutionary studies, sampling of molecular data typically occurs only at the present day (Stadler 2009; Stadler 2011; Morlon et al. 2011) whereas past Poissonian sampling can be introduced to include the sampling of fossil data (Heath et al. 2014) . In epidemiology, concerted sampling at the present day is likely biologically unrealistic , though in some implementations of the models, such a sampling scheme has been imposed. These concerted sampling attempts prior to the present day as well as mass extinction events can be incorporated via the inclusion of Dirac distributions in the sampling and death rates, respectively. Finally, previous models often multiply the likelihood by a factor S in order to condition on a particular observation (e.g., observing at least one lineage or exactly N 0 lineages), enumerate indistinguishable trees (e.g., accounting for possible orientations or unlabeled trees) ( FIGURE 1 . Submodel assumptions. Rate, sampling, mass extinction, and conditioning assumptions of existing submodels of the general time-variable BDS process. The key points are that i) each of the previously developed models we considered can be obtained by adding specific combinations of constraints to the various parameters of the general BDS model; and ii) that there are many plausible, and potentially biologically informative combinations of constraints that have not been considered by researchers in epidemiology or macroevolution.Stadler 2009), or to reflect known uncertainties. The "fossilized-birth-death" likelihood derived by Heath et al. (2014) for example, includes a factor that reflects the uncertainty in the attachment and placement of fossils on the macroevolutionary tree. This fossilized-birth-death process has been used to estimate divergence times and to model lineage diversification (Gavryushkina et al. 2017; Landis et al. 2021) . Variants of the fossilized-birth-death process, for example including mass extinction events, are feasible and can VOL. 71 be derived using our approach. We also note that models similar to the time-variable fossilized-birthdeath process have been developed for cases when phylogenetic data is not available (i.e., when only including fossil occurrence data; see Silvestro et al. 2014; Lehtonen et al. 2017 ); we have not investigated how these models relate to our generalized BDS model but we speculate that it would be possible to also bring these models into a common framework with those that we have discussed. Supplementary material demonstrates how these submodels can be re-derived by either imposing the necessary constraints on the general likelihood formula given in Equation (13) or, alternatively, by starting from the combinations of assumptions and using the five-step procedure outlined above.

The Multitype Birth-Death-Sampling Model

A common extension of the single-type diversification models explored above is to consider cases where the diversification rates (,, ) and probabilities (r,) vary among lineages as a function of a categorical "lineage type". This lineage type can be defined in terms of specific (Maddison et al. 2007; Rasmussen and Stadler 2019) or unspecified traits (Beaulieu and O'Meara 2016) or trait combinations (FitzJohn 2012) (for reviews of these models see Morlon 2014; Ng and Smith 2014) . Representing these lineage types as colors at nodes and along branches of the tree, we first extend the singletype model above by deriving the likelihood of a fully colored tree with topology T where the states along all edges of the phylogeny are known as given by C. The resulting likelihood is an extension of the likelihood first developed by Barido-Sottani et al. (2018) , where the diversification rates and probabilities are allowed to vary arbitrarily through time. To illustrate that our derivation is indeed quite general, we follow the model developed (independently) by Magnuson-Ford and Otto (2012) and Goldberg and Igić (2012) , where the state of lineages can change either anagenetically, with a lineage of type a mutating to a type b at rate a,b () or cladogenetically, with a lineage of type a giving rise to a daughter lineage of type b at rate a,b (). Lineages go extinct at a state-dependent rate a () and are sampled at rate a (). As in the single-type model, upon sampling lineages are removed from the population with probability r a () whereas all lineages alive at the present day are sampled with a probability a (). As discussed in depth by Goldberg and Igić (2012) , the other discrete variations of state-dependent diversification models We use the five-step technique specified above for the single-type case to derive the probability of observing a given colored tree under a general multitype model (see Supplementary material II). We first derive the initial value problem for the probability g e,a () that an edge e of type a in the tree at time gives rise to the subsequently observed phylogeny. The edge e here refers not to an edge in the topological tree, but to a segment of the tree all of one state between birth, sampling, or mutation events. (14) Equation (16) distinguishes between multiple types of birth events as pictured in Supplementary Figure S1 . Birth events may be symmetric, with both daughter lineages inheriting the parental type. The exchangeability of the resulting daughter lineages is reflected in the indicator variable a,b which takes on value of 2 if a = b and 1 otherwise. In contrast asymmetric birth events the resulting daughter lineages differ in type due to caldogenetic change. Importantly, the differential equation for g e,a is linear and hence has a known general solution g e,a = g e,a (s e ) (s e ,). As in the single-type model (s e ,) is the probability flow (Louca and Pennell 2020b) mapping the probability g e,a from the initial state at time s e to the probability at time .An analogous initial value problem can be derived for the probability E a (), that a lineage of type a alive at time leaves no observed descendants in the sampled tree.This is a nonlinear differential equation and must be solved numerically. Given the solution of g e,a and E a the likelihood for the fully colored tree is characterized by a series of critical times: first, x a,b the times at which a lineage of type a gives birth to a lineage of type b, y a the ages of tip samples of type a, z a the ages of ancestral samples of type a, and w a,b the times at which lineages are observed to transition events from type a to type b.The resulting likelihood is given by:Ja j=1 a (y a,j )(1−r a (y a,j ))E a (y a,j )+ a (y a,j )r a (y a,j ) 1 a (y a,j )Here, S is an arbitrary form of conditioning as in Equation (13) and a () = a (,0), a complete list of notation is given in Table S4 . Equation (16) gives the likelihood of a fully colored tree, the tree topology plus the state along each branch and at each node in the tree. This likelihood is a generalization of that presented by (Barido-Sottani et al., 2018 , 2020 . Maximizing Equation (16) while incrementally adding and removing changes in state along the branches of the tree can be used to identify clades with distinct diversification parameters. This method can be used, for example, to identify transmission clusters within a disease outbreak (Barido-Sottani et al. 2018 ). This likelihood is distinct from but related to post-traversal likelihood methods developed to infer state-dependent diversification rates given the known state of sampled lineages (e.g., Maddison et al. 2007; Magnuson-Ford and Otto 2012; . Specifically, these methods give the likelihood L MBDS |T ,C • where C • ={C ,C y ,C z } is the state of present-day, C , past C y , and ancestral, C z , sampled lineages. The relationship between the numerically obtained post-traversal likelihood and the closed-form fully colored likelihood (Equation (16)) is given by:Here, C * is one specific coloring of the tree T (e.g., a maximum parsimony ancestral state reconstruction) that is consistent with the observed states. We include Equation (17) as it clarifies the relationship between these two different approaches that have been used to calculate multitype likelihoods in phylogenetics. Whether or not this is useful for inference is an open question as Pr(C * |T ,C • , MBDS ) is challenging to compute (the details of which are beyond the scope of the present paper).

Concluding Remarks

In this article, we have unified a broad class of BDS models that have been widely used both in epidemiology and macroevolution. And in doing so, we have also presented a standardized notation and approach that can be used both for deriving the various submodels that have previously been studied as well as novel combinations of assumptions about the model parameters. The unification of these models clarifies the connections between BDS variants, facilitates the development of new variants tailored to specific scenarios, and provides a structure for understanding how results depend on model assumptions (Kirkpatrick et al. 2002; Lafferty et al. 2015; Louca and Pennell 2020a) . And importantly, given the recent discovery of widespread nonidentifiability in birth-death processes fit to extant-only (Louca and Pennell 2020a) and serially sampled (Louca et al. 2021 ) phylogenetic data, there is a critical need to explore a much broader range of BDS models than were previously considered and the mathematical generalization presented here will be enable this. In this appendix, we demonstrate how one can obtain the likelihood of submodels with different sets of assumptions by applying constraints to the general likelihood. There are four classes of assumptions that are commonly applied in epidemiological and macroevolutionary studies. First, researchers can make assumptions about the functional form of the birth, death, and sampling rates. Here, we address two such unique assumptions: i) birth, death, and sampling rates are constant (see the Rate Assumptions section, Sections S1.1, S1.2, and S1.5 of the Supplementary material; VOL. 71 and ii) birth, death, and sampling rates are piecewiseconstant functions of time (see Piecewise-constant Rates section, Section S1.6 of the Supplementary material). The cases where birth, death, and sampling rates are defined by a stochastic or deterministic SIR model are mathematically analogous to the cases of the piecewiseconstant and general time-variable models respectively. All additional constraints imposed will depend on the exact compartmental model used and hence we will not discuss them in detail in this section. The second major class of assumptions pertains to sampling. There are four such sampling assumptions: i) sampling happens only at the present day as in a birth-death model (see No Sampling at the Present Section, Sections S1.1, S1.3, and S1.4 of the Supplementary material) or as implemented in the "Birth Death Skyline Contemporary" prior in the BDSKY package in BEAST2; ii) the absence of concerted present-day sampling (see Birth-Death Models section, Section S1.5 of the Supplementary material); iii) the inclusion of ancestral samples with sampled descendants (Sections S1.6 and S1.7 of the Supplementary material; and iv) concerted sampling attempts (CSA) during which all lineages are sampled with a given probability (see Concerted Sampling Attempts section, Section S1.6 of the Supplementary material). The third assumption class considers the presence of mass extinction events (see Mass Extinction section, Section S1.5 of the Supplementary material). The fourth and final major class of assumptions deal with the conditioning of the likelihood. The various conditioning schemes are explored in below and summarized in Supplementary Table S3 available on Dryad.

Constant Rates

• Model assumptions: Constant diversification rates:(t) = , (t) = , (t) = , and constant removal probability r(t) = r.• The IVP for g e ():birth event giving rise to edges e1 and e2 (1−r)g e1 (s e ) ancestral sampling event r + (1−r)E(s e ) terminal sampling event 0 s e = 0, edge sampled at present day• The IVP for E():In this case the IVP for E() is a Bernoulli differential equation and has a known analytical solution. As given by Equation 1 in (Stadler, 2010) this solution is given by:• The probability flow:• The likelihood:

Piecewise-Constant Rates • Model assumptions:

Divide time into L+1 intervals defined by transition times 0 = t 0 < t 1 < t 2 < ... < t L < t L+1 = T. Define rates and removal probabilities constant within a given interval.() = l t l <≤ t l+1 () = l t l <≤ t l+1 () = l t l <≤ t l+1 r() = r l t l << t l+1• The IVP and solution for g e (): Given the definitions of (), (), (), and r() within each time interval the IVP for g e () is identical to that given in Equations (3) and (4). If g l,e () is the probability density within time interval l than g l,e (t l ) = g l−1,e (t l ).• The IVP and solution for E(): As with g e (), the IVP for E() is given by Equation (8). With the piecewise-constant rate assumptions, however, the general solution for E() between t l <≤ t l+1 is known (similar to Equation (A1)). Defining E l () = E() where t l <≤ t l+1 and E l (t l ) = E l−1 (t l ) we have:• The probability flow: We define a probability subflow within each time interval. Specifically, in the lth time interval.The complete flow can be expressed as a function of the subflows in the following manner:where L t is the index of the time t l at or after time t, that is, the largest index such that t l ≤ .• The likelihood: Given these piecewise definitions we substitute them into the general BDS likelihood (13).where we use PC to denote the piecewise-constant assumption.We can simplify several of these products. Let l be the number of birth events ≥ t l and l the number of sampling events ≥ t l .Let n l be the number of observed lineages alive at time t l . Because the number of observed lineages increases with each birth and decreases with each sampled tip, counting the root we have n l = l − l +1. Substituting the expressions for the into the likelihood and using the definition of n l we have:

Birth-Death Models • Model assumptions:

The birth-death model assumes that () = 0. Note that the probability of sampling a lineage given it is alive at the present day remains as 0 (incomplete sampling).• IVP for g e (): Note in this case E() equalsÊ(), the probability a lineage leaves no sampled extant descendants. As demonstrated by (Morlon et al., 2011) there exists a general solution to this initial value problem, see Section ?? for more details. This general solution is given by:• The probability flow: From (Morlon et al., 2011) , the probability flow can be written as the following:• The likelihood:No Sampling at the Present Here, we consider the case when 0 = 0. The likelihood follows exactly as in the general model case. The resulting likelihood expression is given by:(A7) Note that in this case I = n−1.

Concerted Sampling Attempts

• Model assumptions: Here, we introduce L concerted sampling attempts (CSA) at known points in time, t l l ∈ {1,2,...L}. Like the CSA at the present day, and in contrast to the background Poissonian sampling rate, during the CSA at time t l every lineages is sampled with a fixed probability l . In the derivation of the likelihood below, we must distinguish between three different sampling event types. First, past Poissonian sampling events are those that do not occur during CSAs. Second, past concerted sampling events are those that occur during a CSA at time t l l ∈ {1,2,...,L}. Finally, present concerted sampling events are those that occur at the present day = 0. Past concerted sampling attempts can be included in the general model above by adding L Dirac distributions to the Poisson sampling rate function. Namely,where¯ () is the background Poissonian sampling rate and w l =−ln 1− l . The definition of w l comes from solving the CDF of the exponentially distribution for the "effective sampling rate" such that the probability of a lineage being sampled is l .• IVP for g e ():(s e )g e1 (s e )g e2 (s e ) rise birth event giving to edges e1 and e2 (1−r(s e ))¯ (s e )g e1 (s e )Poisson ancestral sampling event (s e )r(s e )+¯ (s e )(1−r(s e ))E(s e ) Poisson terminal sampling event (1−r(t l )) l g e1 (t l ) ancestral sample at t l l r(t l )+ l (1−r(t l ))E(t l ) terminal sample at t l 0 s e = 0, edge sampled at present dayThe solution to g e () is given by Equations (5) and (6).• IVP for E(): As with g e (), the IVP for E() is identical to that given for the general model in Equation (8). Except in rare cases the IVP must be solved numerically hence requiring numerical integration over Dirac distributions which can prove to be problematic.Note however, that when examining the integrals over the CSAs, a priori, it is a matter of convention whether the Dirac distribution should be considered as "integrated over" when located at the upper integration bound b a (s−b)ds = 1 or at the lower integration bound b a (s−a)ds = 1. Whichever convention we chose, we must rigorously obey it so that the ratio (t)/ (s) correctly evaluates to (s,t) whenever s ≤ t. Using the former convention, we can rewrite the probability E(t l ) at each concerted sampling time t l as:where t − l denotes the limit as time approaches t l from below. Hence, the probability E() at any time can be evaluated numerically by considering the dynamics between successive CSAs and at each CSA separately.• The probability flow: The probability flow is given by:As with E() integration over the dirac distributions can be problematic and hence we rewrite this expression separating out these terms. Let L be the oldest CSA occurring at or after time , that is, the largest index for which t l ≤ .(1− l ).(A9) We define:which means that we can rewrite Equation (A9) as:(1− l ).(A11)• The likelihood: The edge representation of g stem is given by:The critical time representation of g stem is given by:where N l is the number of tip samples (samples without descendants) obtained during the lth CSA and M l is the number of ancestral samples (sequences with descendants). By changing how we enumerate birth, death, and sampling events we can greatly simplify this likelihood. First, let l be the number of branching events at or before the lth CSA. In other words, l is the number of branching events if the tree were trimmed at the lth CSA. Then:Second, let l be the number of past Poissonian sampling events before time t l . Then:Finally, let l be the number of past lineages sampled during a CSA at or before the CSA at time t l . Hence, l = N l +N l+1 +...+N L . Then:The likelihood hence simplifies to:Let n l be the number of lineages that cross t l , that is, the number of lineages alive at time t l with sampled descendants at some younger age. Note that by this definition n 0 = 0. Then b l + l +n l is the number of tips in the tree had it been trimmed at age t l whereas l is the number of branching events.

VOL. 71

Therefore we must have l = b l + l +n l −1. This allows us to simplify the conditioned likelihood given below.

MASS EXTINCTION

• Model assumptions: In addition to the Poisson birth death and sampling events considered in the general model, there are L mass extinctions events occurring at times t 1 > t 2 >..t L . During the lth mass extinction event each lineage goes extinct with probability l . As with concerted sampling such mass extinction events can be introduced into the model by adding a set of dirac-delta functions to the Poisson death rate,().where m l =−ln(1− l ).• IVP for g e (): The initial value problem for g e () is identical to that given in equation by Equations (3) and (4) except that is now includes the mass extinction events.• IVP for E(): The IVP for E() to that given by Equation (8) except where the extinction rate is given by Equation (A16). The solution to E() is obtained by numerical integration. Given the dirac-delta functions this numerical integration can be carried out in a piecewise manner integrating separately between and over each mass extinction event. Defining E(t − l ) as the solution up to but not including the mass extinction event at time t l , we have:The first term reflects the probability that a lineage that does not go extinct during the lth mass extinction event leaves no observable offspring (with probability E(t − l )) whereas the second term reflects the fact that all lineages that go extinct during the lth mass extinction leave no observed descendants with probability 1. As with the CSAs, let L be the last index l such that t l <. We can separate out the mass extinction terms in the following way. where¯ () is defined as in Equation (A10).• The likelihood: Given these initial value problems the likelihood follows as in the general model. As with the CSAs we can use relations analogous to Equations A12-A14 to rewrite the likelihood:(1−r(y j ))E(y j )+r(y j ) m k=1 (z k )(1−r(z k )), (A17) where n l is defined as before as the number of lineages present at time t l .

ALTERNATIVE CONDITIONING

Supplementary Table S3 lists a number of possible conditionings, S that can be applied to the tree likelihood. First, is the trivial case of no conditioning S 0 = 1 which gives the probability of the observed tree including the stem edge between time T and t MRCA . To obtain the model likelihood excluding the stem edge, that is, conditioning of the t MRCA , can be obtained by setting S = S 1 = (x 1 ) (T) . Recall that the elements of x are ordered such that x 1 = t MRCA is the first (oldest) birth event.Acknowledging that one would not reconstruct a phylogeny without any sampled lineages, we can condition the likelihood on observing at least one sampled lineage (either at or before the present day) given the time of origin, S 2 = 1 1−E(T) . Or as with S 1 , conditioning on at least one sampled lineage given the t MRCA . In order to have at least one sampled lineage and a most recent common ancestor, however, each daughter lineage of the common ancestor must have at least one descendent. Hence, we have S 3 = (x 1 )The general birth-death-sampling model assumes that all lineages alive at the present day are sampled with probability 0 . As with concerted sampling attempts (CSAs) prior to the present day, this present day CSA may include the sampling of multiple lineages as well as possibly resulting in no sampled lineages. As with S 2 and S 3 we can condition the tree likelihood on observing at least one extant lineage at the present day. To do so, we defineÊ() = E(| = 0), the probability that a lineage alive at time has no extant descendants. Conditioning , where now at least one of the two daughter lineages of the common ancestor has a present day sample. In many cases S 5 is modified, however, to condition on both daughter lineages having an extant sampled descendent: S 5 = (x 1 ) (T) 1 1−Ê(x 1 ) 2 .As an alternative to conditioning on at least one extant sampled descent, tree likelihoods can be conditioned on having exactly N 0 sampled (extant) descendants. Let E N 0 () be the probability a lineage alive at time has exactly N 0 descendants. Although a general expression forÊ N 0 () is unknown, in the case of constant birth, death, and sampling rates (the case in which this form of conditioning has been applied), the expression for E N 0 () is given by (Gernhard, 2008) , (Kendall, 1948) and Theorem 3.3 by (Stadler, 2010) :where, likeÊ,ˆ is given by Equation (10) . When t MRCA is given instead, then the number of descendants of the two daughter lineages must add up to N 0 while both daughter lineages must still have at least one descendant (see (Stadler, 2010) While early BDS models often employed such conditioning (Stadler 2009; Stadler 2010) , this form of conditioning has not been employed in many later models perhaps because the biological justification for such conditioning is vague. The final form of conditioning used in the literature, which we will represent simply as S 8 , is the multiplication of the BDS likelihood by a constant to account for the enumeration over the possible indistinguishable representations of a given tree. The value of this constant depends on whether the tree considered is "labeled" and "oriented" (Gavryushkina et al. 2013 ) and whether, as in the derivation here, the vector of birth events, x, is (un)ordered. Inclusion of such a constant should have no effect on the maximum likelihood inference of the model parameters given a specified tree. In cases where the constant is a function of the critical times (Heath et al. 2014) , it can influence the inference when the parameters and the tree are jointly estimated.

